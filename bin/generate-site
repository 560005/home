#!/usr/bin/env bb
;;; Site generator for 560005.town - pulls data from Datasette and creates Zola pages
;;; Usage: bb bin/generate-site [datasette-url]

(require '[babashka.http-client :as http]
         '[babashka.fs :as fs]
         '[cheshire.core :as json]
         '[clojure.string :as str])

;; Configuration
(def datasette-url (or (first *command-line-args*) "https://edit.560005.town"))
(def content-dir "content")

;; --- Datasette helpers ---

(defn query
  "Execute SQL against Datasette, returns vector of maps."
  [sql & [params]]
  (try
    (let [resp (http/get (str datasette-url "/data.json")
                         {:query-params (merge {"sql" sql "_shape" "objects"} params)
                          :headers {"Accept" "application/json"}})]
      (:rows (json/parse-string (:body resp) true)))
    (catch Exception e
      (println "Error:" sql (.getMessage e))
      [])))

(defn slug [s]
  (-> s str/lower-case str/trim
      (str/replace #"[^a-z0-9\s-]" "")
      (str/replace #"\s+" "-")))

(defn truncate [s n]
  (when s (if (> (count s) n) (str (subs s 0 n) "...") s)))

(defn parse-tags [tags-str]
  (when tags-str
    (try (vec (json/parse-string tags-str))
         (catch Exception _ []))))

;; --- Data fetching ---

(defn fetch-categories-with-counts []
  (query "SELECT c.id, c.slug, c.name, COUNT(l.id) as listing_count
          FROM categories c
          LEFT JOIN listings l ON c.id = l.category_id
          GROUP BY c.id, c.slug, c.name
          ORDER BY c.name"))

(defn fetch-listings-for-category [cat-slug]
  (query "SELECT l.*, c.slug as category_slug, c.name as category_name
          FROM listings l
          JOIN categories c ON l.category_id = c.id
          WHERE c.slug = :slug
          ORDER BY l.name"
         {"slug" cat-slug}))

(defn fetch-all-tags []
  (query "SELECT DISTINCT json_each.value as tag
          FROM listings, json_each(listings.tags)
          WHERE listings.tags IS NOT NULL
          ORDER BY json_each.value"))

(defn fetch-listings-by-tag [tag]
  (query "SELECT l.*, c.slug as category_slug, c.name as category_name
          FROM listings l
          LEFT JOIN categories c ON l.category_id = c.id
          WHERE l.tags IS NOT NULL
            AND EXISTS (SELECT 1 FROM json_each(l.tags) WHERE json_each.value = :tag)
          ORDER BY l.name"
         {"tag" tag}))

;; --- TOML frontmatter ---

(defn toml-value [v]
  (cond
    (string? v)  (str "\"" (str/replace v #"\"" "\\\\\"") "\"")
    (boolean? v) (str v)
    (number? v)  (str v)
    (vector? v)  (json/generate-string v)
    :else        (str "\"" v "\"")))

(defn frontmatter [m & [extra]]
  (str "+++\n"
       (->> m (map (fn [[k v]] (str (name k) " = " (toml-value v)))) (str/join "\n"))
       (when extra
         (str "\n\n[extra]\n"
              (->> extra (map (fn [[k v]] (str (name k) " = " (toml-value v)))) (str/join "\n"))))
       "\n+++\n"))

;; --- Page generators ---

(defn generate-listing-page [cat-slug listing]
  (let [listing-slug (slug (:name listing))
        dir (str content-dir "/c/" cat-slug "/" (:id listing) "-" listing-slug)
        tags (parse-tags (:tags listing))
        fm (frontmatter
            {:title       (str (:name listing) " - 560005.town")
             :description (truncate (or (:description listing) "") 160)
             :template    "listing.html"}
            (merge {:listing_name  (:name listing)
                    :category_slug cat-slug
                    :phone         (or (:phone listing) "")
                    :address       (or (:address listing) "")
                    :tags          (or tags [])
                    :verified      (boolean (:verified listing))
                    :created_at    (or (:created_at listing) "")}
                   (when (number? (:latitude listing))
                     {:latitude  (:latitude listing)
                      :longitude (:longitude listing)})
                   (when (seq (str (:geohash listing)))
                     {:geohash (str (:geohash listing))})))]
    (fs/create-dirs dir)
    (spit (str dir "/index.md")
          (str fm "\n"
               (when (:description listing)
                 (str (:description listing) "\n\n"))
               (when (seq (:phone listing))
                 (str "ğŸ“ " (:phone listing) "\n\n"))
               (when (seq (:address listing))
                 (str "ğŸ“ " (:address listing) "\n\n"))
               (when (seq tags)
                 (str (->> tags (map #(str "[" % "](/t/" (slug %) "/)")) (str/join " ")) "\n\n"))
               (when (:verified listing)
                 "âœ“ Verified\n\n")
               "[â† Back to " cat-slug "](/c/" cat-slug "/)\n"))))

(defn generate-category-page [cat]
  (let [cat-slug (:slug cat)
        cat-name (:name cat)
        listings (fetch-listings-for-category cat-slug)
        dir (str content-dir "/c/" cat-slug)
        fm (frontmatter
            {:title       (str cat-name " - 560005.town")
             :description (str "All " (str/lower-case cat-name) " listings in East Bangalore")
             :template    "category.html"
             :transparent true}
            {:category_name cat-name
             :category_slug cat-slug})]
    (println "  category:" cat-name (str "(" (count listings) " listings)"))
    (fs/create-dirs dir)
    (spit (str dir "/_index.md")
          (str fm "\n# " cat-name "\n\n"
               (if (seq listings)
                 (str "*" (count listings) " listings*\n\n"
                      (->> listings
                           (map (fn [l]
                                  (str "## [" (:name l) "](" (:id l) "-" (slug (:name l)) "/)\n"
                                       (when (:description l) (str (truncate (:description l) 200) "\n"))
                                       (when (seq (:phone l)) (str "ğŸ“ " (:phone l) "  "))
                                       (when (seq (:address l)) (str "ğŸ“ " (:address l)))
                                       "\n\n")))
                           (str/join "")))
                 "*No listings found in this category.*\n")))
    (doseq [l listings]
      (generate-listing-page cat-slug l))))

(defn generate-tag-page [tag]
  (let [tag-name (:tag tag)
        tag-slug (slug tag-name)
        listings (fetch-listings-by-tag tag-name)
        dir (str content-dir "/t/" tag-slug)
        fm (frontmatter
            {:title       (str "#" tag-name " - 560005.town")
             :description (str "All listings tagged with " tag-name)
             :template    "tag.html"}
            {:tag_name tag-name
             :tag_slug tag-slug})]
    (println "  tag:" tag-name (str "(" (count listings) " listings)"))
    (fs/create-dirs dir)
    (spit (str dir "/index.md")
          (str fm "\n# #" tag-name "\n\n"
               (if (seq listings)
                 (str "*" (count listings) " listings*\n\n"
                      (->> listings
                           (map (fn [l]
                                  (str "## [" (:name l) "](/c/" (:category_slug l) "/" (:id l) "-" (slug (:name l)) "/)\n"
                                       (when (:description l) (str (truncate (:description l) 200) "\n"))
                                       "*Category: [" (:category_name l) "](/c/" (:category_slug l) "/)*\n\n")))
                           (str/join "")))
                 "*No listings found with this tag.*\n")))))

(defn generate-index-page [categories tags]
  (let [fm (frontmatter
            {:title       "560005.town - East Bangalore Directory"
             :description "Community-maintained listings of local services, people, and places"
             :template    "index.html"})]
    (spit (str content-dir "/_index.md")
          (str fm "\n# East Bangalore Directory\n\n"
               "Welcome to the community directory for East Bangalore.\n\n"
               "## Categories\n\n"
               (->> categories
                    (map (fn [c] (str "- [" (:name c) "](/c/" (:slug c) "/) *(" (:listing_count c) " listings)*\n")))
                    (str/join ""))
               "\n## Tags\n\n"
               (->> tags (take 20) (map #(str "[" (:tag %) "](/t/" (slug (:tag %)) "/)")) (str/join " "))
               "\n"))))

;; --- Main ---

(defn generate-all []
  (println "ğŸš€ Generating site from" datasette-url)

  ;; Clean and recreate content dir
  (when (fs/exists? content-dir) (fs/delete-tree content-dir))
  (doseq [d [content-dir (str content-dir "/c") (str content-dir "/t")]]
    (fs/create-dirs d))

  ;; Parent sections so child pages are not orphans (required for search indexing)
  (spit (str content-dir "/c/_index.md")
        (frontmatter {:title "Categories" :transparent true :render false :in_search_index false}))
  (spit (str content-dir "/t/_index.md")
        (frontmatter {:title "Tags" :transparent true :render false :in_search_index false}))

  (let [categories (fetch-categories-with-counts)
        tags       (fetch-all-tags)]

    (println "Found" (count categories) "categories," (count tags) "tags")

    (generate-index-page categories tags)
    (println "âœ“ Index page")

    (doseq [cat categories] (generate-category-page cat))
    (println "âœ“ Category pages")

    (doseq [tag tags] (generate-tag-page tag))
    (println "âœ“ Tag pages")

    (println "âœ… Done! Run 'zola serve' to preview.")))

(generate-all)
