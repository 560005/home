<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page.title | default(value="560005.town") }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ page.description | default(value="Community directory for East Bangalore") }}{% endblock %}">
    <link rel="stylesheet" href="{{ get_url(path="style.css", cachebust=true) }}">
</head>
<body>
    <header class="border-b py-2 px-4 mb-4">
        <nav class="flex justify-between items-center max-w mx-auto sm-flex-col">
            <a href="/" class="text-xl font-bold text-blue">560005.town</a>
            <div class="text-sm">
                <a href="/post/">Request a listing</a>
            </div>
        </nav>
        <div class="max-w mx-auto mt-2 relative">
            <input type="text" id="search-input" placeholder="Search listings..." autocomplete="off">
            <div id="search-results" class="absolute top-full left-0 right-0 bg-white border shadow max-h-96 overflow-auto z-10"></div>
        </div>
    </header>

    <main class="max-w mx-auto">
        {% block content %}
        {{ page.content | safe }}
        {% endblock %}
    </main>

    <footer class="py-3 px-4 border-t text-xs text-gray flex justify-between">
        <span>560005.town Â· last updated on {{ now() | date(format="%b %d, %Y") }}</span>
        <a href="/about/">about</a>
    </footer>

    <script>
    (function() {
      var input = document.getElementById("search-input");
      var results = document.getElementById("search-results");
      var index, loaded = false;

      function loadSearch() {
        if (loaded) return;
        loaded = true;
        var s1 = document.createElement("script");
        s1.src = "{{ get_url(path="elasticlunr.min.js") }}";
        s1.onload = function() {
          var s2 = document.createElement("script");
          s2.src = "{{ get_url(path="search_index.en.js") }}";
          s2.onload = function() {
            if (window.searchIndex) index = elasticlunr.Index.load(window.searchIndex);
          };
          document.body.appendChild(s2);
        };
        document.body.appendChild(s1);
      }

      function doSearch() {
        var query = input.value.trim();
        if (!index || query.length < 2) {
          results.innerHTML = "";
          results.style.display = "none";
          return;
        }
        var hits = index.search(query, { expand: false, bool: "AND" })
          .filter(function(hit) { return hit.score > 0.5; });
        if (hits.length === 0) {
          results.innerHTML = "<div class='search-result'>No results found.</div>";
        } else {
          results.innerHTML = hits.slice(0, 10).map(function(hit) {
            var doc = index.documentStore.getDoc(hit.ref);
            var title = doc.title || hit.ref;
            var body = doc.body || "";
            var snippet = body.substring(0, 120).replace(/\n/g, " ");
            var url = hit.ref.replace(/^https?:\/\/[^\/]+/, "");
            return "<a class='search-result' href='" + url + "'>" +
              "<strong>" + title + "</strong>" +
              "<span>" + snippet + "...</span></a>";
          }).join("");
        }
        results.style.display = "block";
      }

      input.addEventListener("focus", loadSearch);
      input.addEventListener("input", doSearch);
      document.addEventListener("click", function(e) {
        if (!results.contains(e.target) && e.target !== input) results.style.display = "none";
      });
    })();
    </script>
</body>
</html>
